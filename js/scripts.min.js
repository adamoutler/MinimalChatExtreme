var oldFileSize=0;var updateRequired=false;var cycles=0.2;var curCycle=1;$(function(){setupHeader();setupChat();updateChat();runAtLoad();setupUsernamePopup()});function setupUsernamePopup(){var a=$(".username-dialog");a.find(".username").keydown(function(b){if(b.which==13){setUsername($(this).val());a.removeClass("visible")}});a.find(".submit").click(function(){setUsername(a.find(".username").val());a.removeClass("visible")});a.find(".cancel").click(function(){a.removeClass("visible")})}function runAtLoad(){loadXMLDoc();if(getUsername().trim()!=""){$(".inputarea .message").attr("placeholder","Send chat message as "+getUsername())}}function loadXMLDoc(){curCycle++;if(curCycle<cycles){return}else{curCycle=0}room=room.substring(0,200);room=room.replace(/[^a-zA-Z0-9]/g,"");$.ajax({cache:false,type:"HEAD",url:getUrl()+"rooms/"+room+".txt",success:function(e,b,c){var a=c.getResponseHeader("Content-Length");if(a==null){a=0}if(a!=oldFileSize){updateRequired=true;oldFileSize=a;cycles=0.2;curcycle=0}else{updateRequired=false;if(cycles<5){cycles=cycles+0.2}}}});if(updateRequired==true){updateChat();updateRequired=false;if(!new Audio().canPlayType("audio/mpeg;")){$(".notifications").hide()}else{if($(".header .enable-notifications").is(":checked")){new Audio("sounds/ding.mp3").play()}}}}setInterval(function(){loadXMLDoc()},1000);function usernamePopup(){var a=$(".username-dialog");a.addClass("visible").find(".username").focus()}function setupHeader(){$(".header .has-menu").click(function(a){a.preventDefault();a.stopPropagation();$(this).toggleClass("menuopen")});$(".header .has-menu ul").click(function(a){a.stopPropagation();closeMenus()});$(".header .clear").click(function(){clearChat()});$(".header .change-username").click(function(){usernamePopup()});$("html").click(function(){closeMenus()})}function closeMenus(){$(".has-menu").removeClass("menuopen")}function setupChat(){var a=$(".inputarea .send");var b=$(".inputarea .message");b.keydown(function(c){if(c.which==13){c.preventDefault();c.stopPropagation();submitMessage()}});a.click(function(){submitMessage()})}function submitMessage(){var a=$(".chatarea");var b=$(".inputarea .message");room=room.replace(/[^a-zA-Z0-9]/g,"");if(getUsername()!=""){$.ajax(getUrl()+"submit.php",{data:{room:room,message:b.val(),user:getUsername()},success:function(d,e,c){updateChat();b.val("")}})}else{$(".username-dialog").addClass("send");usernamePopup()}}function clearChat(){var a=$('<div class="dialog confirm-clear"><div class="title">Are you sure?</div><div class="button submit">Clear Chat</div><div class="button cancel">Cancel</div><div class="clear"></div></div>');a.find(".submit").click(function(){$.ajax(getUrl()+"clear.php",{data:{room:room},success:function(b,c){setTimeout(function(){updateChat()},100)}});a.removeClass("visible");setTimeout(function(){a.remove()},300)});a.find(".cancel").click(function(){a.removeClass("visible");setTimeout(function(){a.remove()},300)});$("body").append(a);setTimeout(function(){a.addClass("visible")},200)}function updateChat(){var a=$(".chatarea");$.ajax(getUrl()+"retrieve.php",{method:"POST",data:{room:room},success:function(f,g,e){var d=$(f);var c=false;d.find(".timestamp").each(function(){c=true;$(this).html(timeDifference($.now()/1000,$(this).html()))});if(c==true){a.html(d)}else{var b;room=room.replace(/[^a-zA-Z0-9]/g,"");$.ajax("rooms/"+room+"clear.txt",{success:function(h,i){b=h;a.html('<div class="no-messages">'+b+"</div>")},error:function(h,j,i){b='<div class="no-messages">No messages to display.</div>';a.html(b)}})}}})}function timeDifference(g,f){var e=60;var c=e*60;var d=c*24;var b=d*30;var h=d*365;var a=g-f;if(a<e){return Math.round(a)+" seconds ago"}else{if(a<c){return Math.round(a/e)+" minutes ago"}else{if(a<d){return Math.round(a/c)+" hours ago"}else{if(a<b){return"approximately "+Math.round(a/d)+" days ago"}else{if(a<h){return"approximately "+Math.round(a/b)+" months ago"}else{return"approximately "+Math.round(a/h)+" years ago"}}}}}}function getUsername(){return getCookie("name")}function setUsername(b){setCookie("name",b);$(".inputarea .message").attr("placeholder","Send chat message as "+b);var a=$(".username-dialog");$(".username-dialog .username").val("");if(a.hasClass("send")){submitMessage();a.removeClass("send")}}function setCookie(a,b){document.cookie=""+a+"="+b+""}function getUrl(){return"//"+window.location.host+window.location.pathname}function getCookie(d){var b=d+"=";var a=document.cookie.split(";");for(var e=0;e<a.length;e++){var f=a[e];while(f.charAt(0)==" "){f=f.substring(1)}if(f.indexOf(b)!=-1){return f.substring(b.length,f.length)}}return""};